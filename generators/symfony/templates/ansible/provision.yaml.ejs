- hosts: server
  tasks:
    - import_role:
        name: postgresql
      vars:
        dbs:
          <%= packageName.replace('-', '_') %>:
            owner: <%= packageName.replace('-', '_') %>
        users:
          <%= packageName.replace('-', '_') %>:
            password: '{{ <%= packageName.replace('-', '_') %>_database_password }}'
    - group:
        name: <%= packageName %>
        state: present
    - user:
        name: <%= packageName %>
        state: present
        group: <%= packageName %>
        shell: /bin/bash
    - import_role:
        name: envfile
      vars:
        owner: <%= packageName %>
        path: /home/<%= packageName %>/env
        env: '{{ <%= packageName %>_env }}'
    - name: Configure env
      lineinfile:
        path: /home/<%= packageName %>/.bashrc
        line: set -a; source /home/<%= packageName %>/env; set +a
    - import_role:
        name: php-fpm-pool
      vars:
        pool: <%= packageName %>
        version: 8.0
        user: <%= packageName %>
        group: <%= packageName %>
        env: '{{ <%= packageName.replace('-', '_') %>_env }}'
        extensions:
          - intl
          - mbstring
          - pgsql
    - import_role:
        name: site
      vars:
        email: '{{ contact_email }}'
        site: <%= packageName %>
        domain: '{{ <%= packageName.replace('-', '_') %>_domain }}'
        config: |
          root /home/<%= packageName %>/current/dist;

          client_max_body_size 25M;

          location / {
            try_files $uri /index.php$is_args$args;
          }

          location ~ ^/index\.php(/|$) {
              fastcgi_pass unix:/var/run/php/<%= packageName %>-7.4.sock;
              fastcgi_split_path_info ^(.+\.php)(/.*)$;
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
              fastcgi_param DOCUMENT_ROOT $realpath_root;
              internal;
          }

          location ~ \.php$ {
              return 404;
          }

          <% if (twig) { %>
          location /assets/ {
              try_files $uri =404;
              add_header cache-control "public, max-age=31536000, immutable";
          }
          <% } %>
  tags:
    - <%= packageName %>
