version: '2.1'

orbs:
  docker: circleci/docker@2.0.1
  php: circleci/php@1.1.0

executors:
  php:
    docker:
      - image: php:8.0.7

commands:
  install-composer:
    steps:
      - run:
          name: Install composer
          command: |
            curl -f -L "https://getcomposer.org/download/2.2.6/composer.phar" -o /usr/local/bin/composer
            echo "1d58486b891e59e9e064c0d54bb38538f74d6014f75481542c69ad84d4e97704 /usr/local/bin/composer" | sha256sum -c -
            chmod 755 /usr/local/bin/composer
          working_directory: /tmp/
  install-php-extensions:
    parameters:
      extensions:
        type: string
    steps:
      - run:
          name: Install PHP extensions
          command: |
            curl --fail --location --output /usr/local/bin/install-php-extensions https://raw.githubusercontent.com/mlocati/docker-php-extension-installer/1.0.4/install-php-extensions
            echo "8bb61096c6cb1edc4d5039cf085c0e774f222c45d3f0546f3c58053a58253fb7 /usr/local/bin/install-php-extensions" | sha256sum -c -
            chmod uga+x /usr/local/bin/install-php-extensions

            install-php-extensions << parameters.extensions >>
          working_directory: /tmp/

jobs:
  <%= packageName %>-php-dependencies:
    docker:
      - image: composer/composer:2.2.6
    steps:
      - checkout
      - php/install-packages:
          app-dir: <%= packagePath %>
          install-flags: --ignore-platform-reqs --no-scripts
      - persist_to_workspace:
          root: .
          paths:
            - <%= packagePath %>/vendor

  <%= packageName %>-php-lint:
    executor: php
    working_directory: ~/project/<%= packagePath %>
    steps:
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project
      - run:
          name: PHP-CS-Fixer
          command: vendor/bin/php-cs-fixer fix --dry-run --diff --using-cache no
      - run:
          name: PHPStan
          command: vendor/bin/phpstan analyse src tests

  <%= packageName %>-migrations:
    docker:
      - image: php:8.0.7
        environment:
          DATABASE_URL: postgresql://thetribe:424242@localhost:5432/thetribe
      - image: postgres:12.5
        environment:
          POSTGRES_USER: thetribe
          POSTGRES_PASSWORD: 424242
    working_directory: ~/project/<%= packagePath %>
    steps:
      - install-php-extensions:
          extensions: intl pdo_pgsql
      - checkout:
          path: ~/project
      - docker/install-dockerize
      - attach_workspace:
          at: ~/project
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run: bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
      - run: bin/console doctrine:schema:validate

  <%= packageName %>-build:
    executor: php
    environment:
      APP_ENV: prod
    working_directory: ~/project/<%= packagePath %>
    steps:
      - install-php-extensions:
          extensions: intl
      - install-composer
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project
      - run: composer install --ignore-platform-reqs --no-scripts --no-dev --optimize-autoloader --classmap-authoritative
      - run: bin/console cache:warmup
      - run: bin/console assets:install
      - run:
          name: Create archive
          command: |
            tar -czf archive.tar.gz --owner=0 --group=0 \
              bin/console \
              config/bootstrap.php \
              config/bundles.php \
              migrations/ \
              public/ \
              src/ \
              var/cache/prod/ \
              vendor/ \
      - store_artifacts:
          path: archive.tar.gz
          destination: <%= packageName %>.tar.gz

workflows:
  version: '2'
  build:
    jobs:
      - <%= packageName %>-build:
          requires:
            - <%= packageName %>-php-dependencies
      - <%= packageName %>-php-dependencies
      - <%= packageName %>-php-lint:
          requires:
            - <%= packageName %>-php-dependencies
      - <%= packageName %>-migrations:
          requires:
            - <%= packageName %>-php-dependencies
