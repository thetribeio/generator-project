- hosts: server
  tasks:
    - import_role:
        name: postgresql
      vars:
        dbs:
          <%= packageName %>:
            owner: <%= packageName %>
        users:
          <%= packageName %>:
            password: '{{ <%= packageName.replace('-', '_') %>_database_password }}'
    - import_role:
        name: nodejs
      vars:
        version: 14
    - group:
        name: <%= packageName %>
        state: present
    - user:
        name: <%= packageName %>
        state: present
        group: <%= packageName %>
    - import_role:
        name: envfile
      vars:
        path: /home/<%= packageName %>/env
        env: '{{ <%= packageName %>_env }}'
    - name: Configure env
      lineinfile:
        path: /home/<%= packageName %>/.bashrc
        line: set -a; source /home/<%= packageName %>/env; set +a
    - import_role:
        name: service
      vars:
        command: /usr/bin/node /home/<%= packageName %>/current/dist
        description: <%= packageName %>
        service: <%= packageName %>
        user: <%= packageName %>
        group: <%= packageName %>
        env: '{{ <%= packageName.replace('-', '_') %>_env }}'
    - import_role:
        name: site
      vars:
        email: '{{ contact_email }}'
        site: <%= packageName %>
        domain: '{{ <%= packageName.replace('-', '_') %>_domain }}'
        config: |
          root /home/<%= packageName %>/current/dist;

          client_max_body_size 25M;

          location / {
              proxy_pass http://localhost:3000/;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
  tags:
    - <%= packageName %>
